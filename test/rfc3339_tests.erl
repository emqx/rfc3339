-module(rfc3339_tests).

-include_lib("eunit/include/eunit.hrl").

rfc3339_test_() ->
    [
        ?_assertEqual({ok, {{0, 1, 1}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"0000-01-01T00:00:00.0+00:00">>)),
        ?_assertEqual({ok, {{9999, 12, 31}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"9999-12-31T00:00:00.0+00:00">>)),
        ?_assertEqual({ok, {{1584, 3, 4}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"1584-03-04T00:00:00.0+00:00">>)),
        ?_assertEqual({ok, {{1900, 1, 1}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"1900-01-01T00:00:00.0+00:00">>)),
        ?_assertEqual({ok, {{2016, 1, 24}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"2016-01-24T00:00:00.0+00:00">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"1970-01-01T00:00:00Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 0, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 500000, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.5Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 550000, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.55Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 555555, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.555555Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 555555, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.5555554Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 999999, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.999999Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 999999, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60.9999999Z">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"1970-01-01T00:00:00+00:00">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {0, 0, 0}, 0, 0}}, rfc3339:parse(<<"1970-01-01T00:00:00-00:00">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {0, 0, 0}, 0, 1439}}, rfc3339:parse(<<"1970-01-01T00:00:00+23:59">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 0, 0}}, rfc3339:parse(<<"1970-01-01T23:59:60+00:00">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 0, 1439}}, rfc3339:parse(<<"1970-01-01T23:59:60+23:59">>)),
        ?_assertEqual({ok, {{1970, 1, 1}, {23, 59, 60}, 0, -1439}}, rfc3339:parse(<<"1970-01-01T23:59:60-23:59">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 0, 0}}, rfc3339:parse(<<"1979-06-21T22:20:03Z">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 0, 0}}, rfc3339:parse(<<"1979-06-21t22:20:03z">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 0, 0}}, rfc3339:parse(<<"1979-06-21 22:20:03Z">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 987654, 0}}, rfc3339:parse(<<"1979-06-21T22:20:03.9876543Z">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 0, 120}}, rfc3339:parse(<<"1979-06-21T22:20:03+02:00">>)),
        ?_assertEqual({ok, {{1979, 6, 21}, {22, 20, 03}, 987654, 120}}, rfc3339:parse(<<"1979-06-21T22:20:03.9876543+02:00">>)),
        ?_assertEqual({ok, <<"1979-06-21T00:00:00Z">>}, rfc3339:format({{1979, 6, 21}, {0, 0, 0}, 0, 0})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12Z">>}, rfc3339:format({{1979, 6, 21}, {12, 12, 12}, 0, 0})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12.120000Z">>}, rfc3339:format({{1979, 6, 21}, {12, 12, 12}, 120000, 0})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12.000012Z">>}, rfc3339:format({{1979, 6, 21}, {12, 12, 12}, 12, 0})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12+12:12">>}, rfc3339:format({{1979, 6, 21}, {12, 12, 12}, 0, 732})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12-12:12">>}, rfc3339:format({{1979, 6, 21}, {12, 12, 12}, 0, -732})),
        ?_assertMatch(#{year := 0, month := 1, day := 1}, rfc3339:to_map(<<"0000-01-01T00:00:00.0+00:00">>)),
        ?_assertMatch(#{year := 9999, month := 12, day := 31}, rfc3339:to_map(<<"9999-12-31T00:00:00.0+00:00">>)),
        ?_assertMatch(#{year := 1584, month := 3, day := 4}, rfc3339:to_map(<<"1584-03-04T00:00:00.0+00:00">>)),
        ?_assertMatch(#{year := 1900, month := 1, day := 1}, rfc3339:to_map(<<"1900-01-01T00:00:00.0+00:00">>)),
        ?_assertMatch(#{year := 2016, month := 1, day := 24}, rfc3339:to_map(<<"2016-01-24T00:00:00.0+00:00">>)),
        ?_assertMatch(#{hour := 0, min := 0, sec := 0}, rfc3339:to_map(<<"1970-01-01T00:00:00Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60}, rfc3339:to_map(<<"1970-01-01T23:59:60Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 500000}, rfc3339:to_map(<<"1970-01-01T23:59:60.5Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 550000}, rfc3339:to_map(<<"1970-01-01T23:59:60.55Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 555555}, rfc3339:to_map(<<"1970-01-01T23:59:60.555555Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 555555}, rfc3339:to_map(<<"1970-01-01T23:59:60.5555554Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 999999}, rfc3339:to_map(<<"1970-01-01T23:59:60.999999Z">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, usec := 999999}, rfc3339:to_map(<<"1970-01-01T23:59:60.9999999Z">>)),
        ?_assertMatch(#{hour := 0, min := 0, sec := 0, tz_offset := 0}, rfc3339:to_map(<<"1970-01-01T00:00:00+00:00">>)),
        ?_assertMatch(#{hour := 0, min := 0, sec := 0, tz_offset := 0}, rfc3339:to_map(<<"1970-01-01T00:00:00-00:00">>)),
        ?_assertMatch(#{hour := 0, min := 0, sec := 0, tz_offset := 1439}, rfc3339:to_map(<<"1970-01-01T00:00:00+23:59">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, tz_offset := 0}, rfc3339:to_map(<<"1970-01-01T23:59:60+00:00">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, tz_offset := 1439}, rfc3339:to_map(<<"1970-01-01T23:59:60+23:59">>)),
        ?_assertMatch(#{hour := 23, min := 59, sec := 60, tz_offset := -1439}, rfc3339:to_map(<<"1970-01-01T23:59:60-23:59">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3}, rfc3339:to_map(<<"1979-06-21T22:20:03Z">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3}, rfc3339:to_map(<<"1979-06-21t22:20:03z">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3}, rfc3339:to_map(<<"1979-06-21 22:20:03Z">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3, usec := 987654}, rfc3339:to_map(<<"1979-06-21T22:20:03.9876543Z">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3, tz_offset := 120}, rfc3339:to_map(<<"1979-06-21T22:20:03+02:00">>)),
        ?_assertMatch(#{year := 1979, month := 6, day := 21, hour := 22, min := 20, sec := 3, usec := 987654, tz_offset := 120}, rfc3339:to_map(<<"1979-06-21T22:20:03.9876543+02:00">>)),
        ?_assertEqual({ok, <<"1979-06-21T00:00:00Z">>}, rfc3339:format(#{year => 1979, month => 6, day => 21})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12Z">>}, rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12.120000Z">>}, rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, usec => 120000})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12.000012Z">>}, rfc3339:format(#{year => 1979, month => 6, day => 21,hour => 12, min => 12, sec => 12, usec => 12})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12+12:12">>}, rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, tz_offset => 732})),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12-12:12">>}, rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, tz_offset => -732})),
        ?_assertEqual(
            #{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, usec => 120000, tz_offset => 732},
            rfc3339:to_map(<<"1979-06-21T12:12:12.12+12:12">>)
        ),
        ?_assertEqual(
            {ok, <<"1979-06-21T12:12:12.120000+12:12">>},
            rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, usec => 120000, tz_offset => 732})
        ),
        ?_assertEqual(
            #{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12, usec => 0, tz_offset => 0},
            rfc3339:to_map(<<"1979-06-21T12:12:12Z">>)
        ),
        ?_assertEqual(
            {ok, <<"1979-06-21T12:12:12Z">>},
            rfc3339:format(#{year => 1979, month => 6, day => 21, hour => 12, min => 12, sec => 12})
        ),
        ?_assertEqual({ok, 0}, rfc3339:to_time(<<"1970-01-01T00:00:00Z">>, micro_seconds)),
        ?_assertEqual({ok, <<"1970-01-01T00:00:00Z">>}, rfc3339:format(0, micro_seconds)),
        ?_assertEqual({ok, 543210}, rfc3339:to_time(<<"1970-01-01T00:00:00.54321Z">>, micro_seconds)),
        ?_assertEqual({ok, <<"1970-01-01T00:00:00.543210Z">>}, rfc3339:format(543210, micro_seconds)),
        ?_assertEqual({ok, 543}, rfc3339:to_time(<<"1970-01-01T00:00:00.54321Z">>, milli_seconds)),
        ?_assertEqual({ok, <<"1970-01-01T00:00:00.543000Z">>}, rfc3339:format(543, milli_seconds)),
        ?_assertEqual({ok, 543210000}, rfc3339:to_time(<<"1970-01-01T00:00:00.54321Z">>, nano_seconds)),
        ?_assertEqual({ok, <<"1970-01-01T00:00:00.543000Z">>}, rfc3339:format(543000000, nano_seconds)),
        ?_assertEqual({ok, 6543210}, rfc3339:to_time(<<"1970-01-01T00:00:06.54321Z">>, micro_seconds)),
        ?_assertEqual({ok, <<"1970-01-01T00:00:06.543210Z">>}, rfc3339:format(6543210, micro_seconds)),
        ?_assertEqual({ok, 298815132000000}, rfc3339:to_time(<<"1979-06-21T12:12:12Z">>, micro_seconds)),
        ?_assertEqual({ok, <<"1979-06-21T12:12:12Z">>}, rfc3339:format(298815132000000, micro_seconds)),
        ?_assertEqual({ok, -1613826000000000}, rfc3339:to_time(<<"1918-11-11T11:00:00Z">>, micro_seconds)),
        ?_assertEqual({ok, <<"1918-11-11T11:00:00Z">>}, rfc3339:format(-1613826000000000, micro_seconds)),
        ?_assertEqual({ok, -1613818800000000}, rfc3339:to_time(<<"1918-11-11T11:00:00+02:00">>, micro_seconds)),
        ?_assertEqual({ok, <<"1918-11-11T13:00:00Z">>}, rfc3339:format(-1613818800000000, micro_seconds)),
        ?_assertEqual({error, badarg}, rfc3339:parse(1)),
        ?_assertEqual({error, baddate}, rfc3339:parse(<<"79-06-21T00:00:00Z">>)),
        ?_assertEqual({error, badyear}, rfc3339:parse(<<"xxxx-06-21T00:00:00Z">>)),
        ?_assertEqual({error, badmonth}, rfc3339:parse(<<"1979-xx-21T00:00:00Z">>)),
        ?_assertEqual({error, badday}, rfc3339:parse(<<"1979-06-xxT00:00:00Z">>)),
        ?_assertEqual({error, badtime}, rfc3339:parse(<<"1979-06-21-00:00:00Z">>)),
        ?_assertEqual({error, badhour}, rfc3339:parse(<<"1979-06-21Txx:00:00Z">>)),
        ?_assertEqual({error, badminute}, rfc3339:parse(<<"1979-06-21T00:xx:00Z">>)),
        ?_assertEqual({error, badsecond}, rfc3339:parse(<<"1979-06-21T00:00:xxZ">>)),
        ?_assertEqual({error, badtimezone}, rfc3339:parse(<<"1979-06-21T00:00:00x">>))
    ].
